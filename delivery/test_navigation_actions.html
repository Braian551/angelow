<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API - Cancelación y Reportes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { padding: 20px; background: #f5f5f5; }
        .test-card { margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .response { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 10px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4"><i class="fas fa-vial"></i> Test API - Navigation Actions</h1>
        
        <div class="alert alert-info">
            <strong>Nota:</strong> Debes estar logueado como conductor (delivery) para ejecutar estos tests.
            <br>Delivery ID actual: <strong id="currentDeliveryId">9</strong>
        </div>

        <!-- Test 1: Get Problem Types -->
        <div class="test-card">
            <h4><i class="fas fa-list"></i> Test 1: Obtener Tipos de Problemas</h4>
            <p class="text-muted">GET /delivery/api/navigation_actions.php?action=get_problem_types</p>
            <button class="btn btn-primary" onclick="testGetProblemTypes()">
                <i class="fas fa-play"></i> Ejecutar Test
            </button>
            <div id="response1" class="response" style="display:none;"></div>
        </div>

        <!-- Test 2: Get Cancellation Reasons -->
        <div class="test-card">
            <h4><i class="fas fa-ban"></i> Test 2: Obtener Razones de Cancelación</h4>
            <p class="text-muted">GET /delivery/api/navigation_actions.php?action=get_cancellation_reasons</p>
            <button class="btn btn-primary" onclick="testGetCancellationReasons()">
                <i class="fas fa-play"></i> Ejecutar Test
            </button>
            <div id="response2" class="response" style="display:none;"></div>
        </div>

        <!-- Test 3: Cancel Navigation -->
        <div class="test-card">
            <h4><i class="fas fa-times-circle"></i> Test 3: Cancelar Navegación</h4>
            <p class="text-muted">POST /delivery/api/navigation_actions.php?action=cancel_navigation</p>
            <div class="form-group">
                <label>Delivery ID:</label>
                <input type="number" class="form-control" id="deliveryIdCancel" value="9">
            </div>
            <div class="form-group">
                <label>Razón:</label>
                <select class="form-control" id="cancelReason">
                    <option value="customer_unavailable">Cliente No Disponible</option>
                    <option value="technical_issue">Problema Técnico</option>
                    <option value="other">Otra Razón</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notas:</label>
                <textarea class="form-control" id="cancelNotes" rows="2">Test de cancelación desde interfaz de pruebas</textarea>
            </div>
            <button class="btn btn-warning" onclick="testCancelNavigation()">
                <i class="fas fa-play"></i> Ejecutar Test
            </button>
            <div id="response3" class="response" style="display:none;"></div>
        </div>

        <!-- Test 4: Report Problem -->
        <div class="test-card">
            <h4><i class="fas fa-exclamation-circle"></i> Test 4: Reportar Problema</h4>
            <p class="text-muted">POST /delivery/api/navigation_actions.php?action=report_problem</p>
            <div class="form-group">
                <label>Delivery ID:</label>
                <input type="number" class="form-control" id="deliveryIdReport" value="9">
            </div>
            <div class="form-group">
                <label>Tipo de Problema:</label>
                <select class="form-control" id="problemType">
                    <option value="gps_error">Error de GPS</option>
                    <option value="route_blocked">Ruta Bloqueada</option>
                    <option value="traffic_jam">Tráfico Pesado</option>
                </select>
            </div>
            <div class="form-group">
                <label>Severidad:</label>
                <select class="form-control" id="severity">
                    <option value="low">Baja</option>
                    <option value="medium" selected>Media</option>
                    <option value="high">Alta</option>
                    <option value="critical">Crítica</option>
                </select>
            </div>
            <div class="form-group">
                <label>Título:</label>
                <input type="text" class="form-control" id="problemTitle" value="Test de reporte de problema">
            </div>
            <div class="form-group">
                <label>Descripción:</label>
                <textarea class="form-control" id="problemDescription" rows="3">Esta es una descripción de prueba del problema reportado desde la interfaz de testing.</textarea>
            </div>
            <button class="btn btn-danger" onclick="testReportProblem()">
                <i class="fas fa-play"></i> Ejecutar Test
            </button>
            <div id="response4" class="response" style="display:none;"></div>
        </div>

        <!-- Test 5: Verificar en Base de Datos -->
        <div class="test-card">
            <h4><i class="fas fa-database"></i> Test 5: Verificar Datos en Base de Datos</h4>
            <p class="text-muted">Consultar registros creados</p>
            <button class="btn btn-info" onclick="showSQLQueries()">
                <i class="fas fa-terminal"></i> Mostrar Queries SQL
            </button>
            <div id="response5" class="response" style="display:none;">
                <h6>Ejecuta estos comandos en MySQL:</h6>
                <pre>
-- Ver últimas cancelaciones
SELECT * FROM delivery_navigation_cancellations 
ORDER BY created_at DESC LIMIT 3;

-- Ver últimos problemas reportados
SELECT * FROM delivery_problem_reports 
ORDER BY created_at DESC LIMIT 3;

-- Ver vista consolidada
SELECT * FROM v_navigation_issues 
WHERE DATE(created_at) = CURDATE()
ORDER BY created_at DESC;
                </pre>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = window.location.origin;
        const API_URL = BASE_URL + '/delivery/api/navigation_actions.php';

        async function testGetProblemTypes() {
            const responseDiv = document.getElementById('response1');
            responseDiv.style.display = 'block';
            responseDiv.className = 'response';
            responseDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ejecutando...';

            try {
                const response = await fetch(`${API_URL}?action=get_problem_types`);
                const data = await response.json();
                
                responseDiv.className = data.success ? 'response success' : 'response error';
                responseDiv.innerHTML = '<strong>Status:</strong> ' + response.status + '<br>' +
                                       '<strong>Response:</strong><br>' + 
                                       JSON.stringify(data, null, 2);
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.innerHTML = '<strong>Error:</strong> ' + error.message;
            }
        }

        async function testGetCancellationReasons() {
            const responseDiv = document.getElementById('response2');
            responseDiv.style.display = 'block';
            responseDiv.className = 'response';
            responseDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ejecutando...';

            try {
                const response = await fetch(`${API_URL}?action=get_cancellation_reasons`);
                const data = await response.json();
                
                responseDiv.className = data.success ? 'response success' : 'response error';
                responseDiv.innerHTML = '<strong>Status:</strong> ' + response.status + '<br>' +
                                       '<strong>Response:</strong><br>' + 
                                       JSON.stringify(data, null, 2);
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.innerHTML = '<strong>Error:</strong> ' + error.message;
            }
        }

        async function testCancelNavigation() {
            const responseDiv = document.getElementById('response3');
            responseDiv.style.display = 'block';
            responseDiv.className = 'response';
            responseDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ejecutando...';

            const requestData = {
                delivery_id: parseInt(document.getElementById('deliveryIdCancel').value),
                reason: document.getElementById('cancelReason').value,
                notes: document.getElementById('cancelNotes').value,
                latitude: -12.046374,
                longitude: -77.042793
            };

            try {
                const response = await fetch(`${API_URL}?action=cancel_navigation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                const data = await response.json();
                
                responseDiv.className = data.success ? 'response success' : 'response error';
                responseDiv.innerHTML = '<strong>Status:</strong> ' + response.status + '<br>' +
                                       '<strong>Request:</strong><br>' + JSON.stringify(requestData, null, 2) + '<br><br>' +
                                       '<strong>Response:</strong><br>' + JSON.stringify(data, null, 2);
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.innerHTML = '<strong>Error:</strong> ' + error.message;
            }
        }

        async function testReportProblem() {
            const responseDiv = document.getElementById('response4');
            responseDiv.style.display = 'block';
            responseDiv.className = 'response';
            responseDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ejecutando...';

            const requestData = {
                delivery_id: parseInt(document.getElementById('deliveryIdReport').value),
                problem_type: document.getElementById('problemType').value,
                severity: document.getElementById('severity').value,
                title: document.getElementById('problemTitle').value,
                description: document.getElementById('problemDescription').value,
                latitude: -12.046374,
                longitude: -77.042793
            };

            try {
                const response = await fetch(`${API_URL}?action=report_problem`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                const data = await response.json();
                
                responseDiv.className = data.success ? 'response success' : 'response error';
                responseDiv.innerHTML = '<strong>Status:</strong> ' + response.status + '<br>' +
                                       '<strong>Request:</strong><br>' + JSON.stringify(requestData, null, 2) + '<br><br>' +
                                       '<strong>Response:</strong><br>' + JSON.stringify(data, null, 2);
            } catch (error) {
                responseDiv.className = 'response error';
                responseDiv.innerHTML = '<strong>Error:</strong> ' + error.message;
            }
        }

        function showSQLQueries() {
            const responseDiv = document.getElementById('response5');
            responseDiv.style.display = responseDiv.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>
