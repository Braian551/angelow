@startuml Mapa de Procesos - Sistema Angelow
skinparam backgroundColor #FEFEFE
skinparam activity {
    BackgroundColor #FFFFFF
    BorderColor #333333
    BorderThickness 2
    FontSize 11
}

skinparam partition {
    BackgroundColor #F8F8F8
    BorderColor #666666
    BorderThickness 2
}

skinparam note {
    BackgroundColor #FFFACD
    BorderColor #FFA500
}

title Mapa de Procesos - Sistema Angelow

start

partition "Descubrimiento y Registro" as Discovery {
    :Usuario accede a index con sliders y anuncios;
    :Explora colecciones y categorías destacadas;
    :Utiliza buscador (guarda historial);
    :Revisa alertas y wishlist pública;

    if (¿Sesion activa?) then (No)
        :Limita funciones sensibles;
        :Ofrece login/registro tradicional y Google;
        if (¿Desea crear cuenta?) then (Sí)
            :Completa formulario validado;
            :Verifica email único e intenta reCAPTCHA;
            :Envía correo de confirmación;
            :Autentica sesión;
        else (No)
            :Continúa como invitado;
        endif
    else (Sí)
        :Muestra panel mini con órdenes y alerts;
    endif
}

partition "Selección y Carrito" as Selection {
    :Revisa detalle de producto con tabs, reseñas y preguntas;
    :Gestiona tallas/variantes e inventario real-time;
        :Añade a carrito o Lista de Deseos;
    if (¿Producto disponible?) then (Sí)
        :Carrito almacena en BD sesiones;
        :Permite aplicar cupones y calculadora envío;
    else (No)
        :Ofrece alerta de reposición;
        end
    endif

    if (¿Desea finalizar compra?) then (Sí)
            :Avanza al Paso 1 de Pago (cart.php);
    else (No)
        :Sigue navegando;
    endif
}

partition "Pago y Finalización" as Checkout {
    :Paso 1 - Confirma items y totales;
    :Paso 2 - Selecciona dirección + geocoding;
    :Paso 3 - Elige método envío y pago;
    :Muestra instrucciones bancarias y formularios de comprobante;
    if (¿Sesion válida?) then (No)
        :Solicita autenticación previa;
        stop
    endif

    :Genera orden en estado Pendiente;
    :Bloquea stock reservado;
    :Usuario sube comprobante y comentarios;
    :Se envían notificaciones a admin y cliente;
}

partition "Validación y Gestión de Pedidos" as Orders {
    :Orden visible en dashboard admin y usuario;
    fork
        :Equipo de pagos revisa comprobante;
        if (¿Comprobante válido?) then (Sí)
            :Actualiza estado a Pagado;
            :Registra histórico y badge de orden;
        else (No)
            :Rechaza pago y pide nuevo archivo;
            :Notifica al cliente;
            end
        endif
    fork again
        :Soporte verifica inventario final;
        if (¿Stock suficiente?) then (Sí)
            :Genera picking list;
        else (No)
            :Ejecuta cancelación o sustitución;
            :Devuelve stock bloqueado;
            end
        endif
    join

    :Orden pasa a estado Preparando;
    :Se imprimen facturas y etiquetas;
}

partition "Preparación y Envío" as Shipping {
    :Empacado y control de calidad;
    :Selecciona regla de envío (mensajería, retiro, externo);
    :Registra método shipping_method_id;
    :Genera guía y tracking (si aplica);
    :Actualiza estado a Enviado;
    :Dispara correos/SMS con tracking o instrucciones de retiro;
    note right
        El rol delivery fue removido.
        El control se realiza desde
        reglas de envío y aliados externos.
    end note
}

partition "Procesos Administrativos" as AdminOps {
    fork
        :Catálogo y contenido (productos, colecciones, sliders, anuncios);
    fork again
        :Gestión de descuentos masivos y cupones;
    fork again
        :Reglas de envío y costos dinámicos;
    fork again
        :Reportes (ventas, productos, clientes) y paneles en vivo;
    fork again
        :Gestión de usuarios/admins, perfiles y notificaciones internas;
    fork again
        :Monitoreo AJAX (badges, dashboards, alertas);
    join
}

partition "Postventa y Engagement" as PostSale {
    :Cliente recibe notificación de entrega;
    :Puede confirmar recepción desde panel;
    :Accede a factura PDF y historial completo;
    :Puede calificar servicio, dejar reseña o pregunta;
    :Sistema actualiza rating y muestra en ficha producto;
        :Activa alertas de Lista de Deseos o reordenar;
    note right
        Se conservan logs y auditoría
        para todo el ciclo, incluyendo
        notificaciones y búsquedas.
    end note
}

:Fin del proceso;

stop

' ===== CONEXIONES ENTRE PROCESOS =====
Discovery --> Selection : Usuario autenticado o invitado
Selection --> Checkout : Decide finalizar
Checkout --> Orders : Orden generada
Orders --> Shipping : Estado listo para enviar
Shipping --> PostSale : Entrega confirmada
AdminOps --> Orders : Validaciones y ajustes
AdminOps --> Shipping : Define reglas/logística

' ===== NOTAS ADICIONALES =====
note as N1
    **Características Clave 2025:**
    - Pago en 3 pasos con geocoding
    - Validación manual de transferencias
    - 80+ tablas con historial y auditoría
    - Alertas de Lista de Deseos y anuncios dinámicos
end note

note as N2
    **Tiempos Estimados:**
    - Descubrimiento: inmediato
    - Validación de pago: 0-24h
    - Preparación: 2-6h
    - Envío courier: 1-72h según método
end note

note as N3
    **Decisiones Críticas:**
    - Autenticación previa al pago
    - Verificación de stock antes de preparar
    - Aprobación o rechazo de comprobante
    - Selección de regla de envío disponible
end note

@enduml