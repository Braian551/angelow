DELIMITER //

DROP PROCEDURE IF EXISTS GetFilteredProducts //

CREATE PROCEDURE GetFilteredProducts(
    IN p_search_query VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci,
    IN p_category_id INT,
    IN p_gender VARCHAR(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci,
    IN p_min_price DECIMAL(10,2),
    IN p_max_price DECIMAL(10,2),
    IN p_sort_by VARCHAR(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci,
    IN p_limit INT,
    IN p_offset INT,
    IN p_user_id VARCHAR(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci,
    IN p_show_offers_only TINYINT,
    IN p_collection_id INT
)
BEGIN
    DECLARE effective_limit INT DEFAULT IFNULL(p_limit, 12);
    DECLARE effective_offset INT DEFAULT IFNULL(p_offset, 0);

    SELECT DISTINCT
        p.id,
        p.name,
        p.slug,
        p.description,
        p.price,
        p.compare_price,
        p.category_id,
        p.collection_id,
        p.gender,
        p.is_featured,
        p.is_active,
        p.created_at,
        p.updated_at,
        (SELECT image_path FROM product_images WHERE product_id = p.id AND is_primary = 1 ORDER BY id ASC LIMIT 1) AS primary_image,
        COALESCE(AVG(pr.rating), 0) AS avg_rating,
        COUNT(DISTINCT pr.id) AS review_count,
        MIN(COALESCE(psv.price, p.price)) AS min_price,
        MAX(COALESCE(psv.price, p.price)) AS max_price,
        CASE
            WHEN p_user_id IS NOT NULL AND p_user_id <> '' THEN
                EXISTS (
                    SELECT 1 FROM wishlist w
                    WHERE w.user_id = p_user_id COLLATE utf8mb4_general_ci
                      AND w.product_id = p.id
                )
            ELSE 0
        END AS is_favorite
    FROM products p
    LEFT JOIN product_color_variants pcv ON pcv.product_id = p.id
    LEFT JOIN product_size_variants psv ON psv.color_variant_id = pcv.id AND psv.is_active = 1
    LEFT JOIN product_reviews pr ON pr.product_id = p.id AND pr.is_approved = 1
    WHERE p.is_active = 1
        AND (
            p_search_query IS NULL OR p_search_query = ''
            OR p.name LIKE CONCAT('%', p_search_query, '%') COLLATE utf8mb4_general_ci
            OR p.description LIKE CONCAT('%', p_search_query, '%') COLLATE utf8mb4_general_ci
        )
        AND (p_category_id IS NULL OR p.category_id = p_category_id)
        AND (
            p_gender IS NULL OR p_gender = ''
            OR p.gender = p_gender COLLATE utf8mb4_general_ci
        )
        AND (p_min_price IS NULL OR COALESCE(psv.price, p.price) >= p_min_price)
        AND (p_max_price IS NULL OR COALESCE(psv.price, p.price) <= p_max_price)
        AND (
            p_collection_id IS NULL
            OR p.collection_id = p_collection_id
            OR EXISTS (
                SELECT 1
                FROM product_collections pc
                WHERE pc.product_id = p.id
                  AND pc.collection_id = p_collection_id
            )
        )
        AND (
            p_show_offers_only = 0
            OR p.compare_price > p.price
            OR EXISTS (
                SELECT 1
                FROM product_size_variants osv
                WHERE osv.color_variant_id = pcv.id
                  AND osv.is_active = 1
                  AND osv.compare_price IS NOT NULL
                  AND osv.compare_price > osv.price
            )
        )
    GROUP BY p.id, p.name, p.slug, p.description, p.price, p.compare_price,
             p.category_id, p.collection_id, p.gender, p.is_featured,
             p.is_active, p.created_at, p.updated_at
    ORDER BY
        CASE WHEN p_sort_by = 'price_asc' THEN MIN(COALESCE(psv.price, p.price)) END ASC,
        CASE WHEN p_sort_by = 'price_desc' THEN MAX(COALESCE(psv.price, p.price)) END DESC,
        CASE WHEN p_sort_by = 'name_asc' THEN p.name END ASC,
        CASE WHEN p_sort_by = 'name_desc' THEN p.name END DESC,
        CASE WHEN p_sort_by = 'popular' THEN COUNT(DISTINCT pr.id) END DESC,
        p.is_featured DESC,
        p.created_at DESC
    LIMIT effective_limit OFFSET effective_offset;

    SELECT COUNT(DISTINCT p.id) AS total
    FROM products p
    LEFT JOIN product_color_variants pcv ON pcv.product_id = p.id
    LEFT JOIN product_size_variants psv ON psv.color_variant_id = pcv.id AND psv.is_active = 1
    WHERE p.is_active = 1
        AND (
            p_search_query IS NULL OR p_search_query = ''
            OR p.name LIKE CONCAT('%', p_search_query, '%') COLLATE utf8mb4_general_ci
            OR p.description LIKE CONCAT('%', p_search_query, '%') COLLATE utf8mb4_general_ci
        )
        AND (p_category_id IS NULL OR p.category_id = p_category_id)
        AND (
            p_gender IS NULL OR p_gender = ''
            OR p.gender = p_gender COLLATE utf8mb4_general_ci
        )
        AND (p_min_price IS NULL OR COALESCE(psv.price, p.price) >= p_min_price)
        AND (p_max_price IS NULL OR COALESCE(psv.price, p.price) <= p_max_price)
        AND (
            p_collection_id IS NULL
            OR p.collection_id = p_collection_id
            OR EXISTS (
                SELECT 1
                FROM product_collections pc
                WHERE pc.product_id = p.id
                  AND pc.collection_id = p_collection_id
            )
        )
        AND (
            p_show_offers_only = 0
            OR p.compare_price > p.price
            OR EXISTS (
                SELECT 1
                FROM product_size_variants osv
                WHERE osv.color_variant_id = pcv.id
                  AND osv.is_active = 1
                  AND osv.compare_price IS NOT NULL
                  AND osv.compare_price > osv.price
            )
        );
END //

DELIMITER ;
